#Send pings
from ripe.atlas.cousteau import (
  Ping,
  Traceroute,
    AtlasSource,
    AtlasResultsRequest,
    AtlasCreateRequest,
    AtlasStopRequest,
    Measurement
)
import pandas as pd
import numpy as np
import ast
from tqdm import tqdm
from random import sample
from datetime import datetime,timedelta,timezone
from ipaddress import ip_address,ip_network,ip_interface
import time
import json
import threading
import math
from geopy.geocoders import Nominatim
from geopy.distance import geodesic
import random
import json
import csv
import os
from datetime import date
import socket
import geoip2.database
import requests
import sys
import ipaddress

inpt = """162.17.174.14-162.17.174.0/26
173.10.109.5-173.10.109.0/26
173.10.115.2-173.10.115.0/28
173.10.120.226-173.10.120.224/29
173.10.64.129-173.10.64.128/27
173.10.69.209-173.10.69.208/30
173.10.71.186-173.10.71.176/28
173.10.79.199-173.10.79.192/28
173.10.84.135-173.10.84.128/28
173.10.85.22-173.10.85.0/27
173.10.87.216-173.10.87.192/27
173.14.243.105-173.14.243.96/28
173.14.250.51-173.14.250.0/26
173.160.145.102-173.160.145.96/28
173.160.147.26-173.160.147.16/28
173.160.160.86-173.160.160.64/27
173.160.164.155-173.160.164.128/27
173.160.164.165-173.160.164.160/28
173.160.164.180-173.160.164.176/29
173.160.164.189-173.160.164.188/30
173.160.176.2-173.160.176.0/30
173.160.176.218-173.160.176.208/28
173.160.190.204-173.160.190.200/29
173.160.197.253-173.160.197.224/27
173.160.199.149-173.160.199.128/27
173.160.204.198-173.160.204.196/30
173.160.204.228-173.160.204.228/31
173.160.232.228-173.160.232.224/28
173.160.250.152-173.160.250.128/27
174.165.16.6-174.165.16.0/26
174.165.16.79-174.165.16.64/26
174.165.16.154-174.165.16.128/26
174.165.16.254-174.165.16.192/26
174.165.17.4-174.165.17.0/26
174.165.17.107-174.165.17.64/26
174.165.17.132-174.165.17.128/26
174.165.17.249-174.165.17.192/26
174.165.18.2-174.165.18.0/26
174.165.18.72-174.165.18.64/26
174.165.18.178-174.165.18.128/26
174.165.18.197-174.165.18.192/26
174.165.19.2-174.165.19.0/26
174.165.19.109-174.165.19.64/26
174.165.19.178-174.165.19.128/26
174.165.19.219-174.165.19.192/26
174.165.20.1-174.165.20.0/26
174.165.20.81-174.165.20.64/26
174.165.20.128-174.165.20.128/26
174.165.20.254-174.165.20.192/26
174.165.21.2-174.165.21.0/26
174.165.21.119-174.165.21.64/26
174.165.21.190-174.165.21.128/26
174.165.21.255-174.165.21.192/26
174.165.22.1-174.165.22.0/26
174.165.22.69-174.165.22.64/26
174.165.22.137-174.165.22.128/26
174.165.22.209-174.165.22.192/26
174.165.23.1-174.165.23.0/26
174.165.23.91-174.165.23.64/26
174.165.23.160-174.165.23.128/26
174.165.23.211-174.165.23.192/26
174.165.16.6-174.165.16.0/26
174.165.16.79-174.165.16.64/26
174.165.16.142-174.165.16.128/26
174.165.16.225-174.165.16.192/26
174.165.17.3-174.165.17.0/26
174.165.17.82-174.165.17.64/26
174.165.17.161-174.165.17.128/26
174.165.17.249-174.165.17.192/26
174.165.18.0-174.165.18.0/26
174.165.18.72-174.165.18.64/26
174.165.18.151-174.165.18.128/26
174.165.18.237-174.165.18.192/26
174.165.19.2-174.165.19.0/26
174.165.19.119-174.165.19.64/26
174.165.19.162-174.165.19.128/26
174.165.19.219-174.165.19.192/26
174.165.20.1-174.165.20.0/26
174.165.20.90-174.165.20.64/26
174.165.20.181-174.165.20.128/26
174.165.20.222-174.165.20.192/26
174.165.21.3-174.165.21.0/26
174.165.21.80-174.165.21.64/26
174.165.21.168-174.165.21.128/26
174.165.21.255-174.165.21.192/26
174.165.22.1-174.165.22.0/26
174.165.22.88-174.165.22.64/26
174.165.22.187-174.165.22.128/26
174.165.22.252-174.165.22.192/26
174.165.23.1-174.165.23.0/26
174.165.23.73-174.165.23.64/26
174.165.23.160-174.165.23.128/26
174.165.23.239-174.165.23.192/26
174.165.16.146-174.165.16.128/27
174.165.16.160-174.165.16.160/28
174.165.16.177-174.165.16.177/32
174.165.16.179-174.165.16.178/31
174.165.16.181-174.165.16.180/30
174.165.16.188-174.165.16.184/29
174.165.16.215-174.165.16.192/27
174.165.16.247-174.165.16.224/27
174.165.16.79-174.165.16.64/27
174.165.17.3-174.165.17.0/26
174.165.17.77-174.165.17.64/26
174.165.17.191-174.165.17.128/26
174.165.17.249-174.165.17.240/28
174.165.18.0-174.165.18.0/28
174.165.18.129-174.165.18.128/30
174.165.18.133-174.165.18.132/31
174.165.18.135-174.165.18.135/32
174.165.18.138-174.165.18.136/29
174.165.18.154-174.165.18.144/28
174.165.18.190-174.165.18.160/27
174.165.18.206-174.165.18.192/28
174.165.18.208-174.165.18.208/32
174.165.18.210-174.165.18.210/31
174.165.18.215-174.165.18.212/30
174.165.18.220-174.165.18.216/29
174.165.18.244-174.165.18.224/27
174.165.18.72-174.165.18.64/27
174.165.19.0-174.165.19.0/27
174.165.19.141-174.165.19.128/27
174.165.19.177-174.165.19.160/27
174.165.19.219-174.165.19.192/27
174.165.19.79-174.165.19.64/28
174.165.19.83-174.165.19.80/28
174.165.19.102-174.165.19.96/27
174.165.20.0-174.165.20.0/28
174.165.20.101-174.165.20.100/30
174.165.20.107-174.165.20.104/29
174.165.20.113-174.165.20.112/28
174.165.20.148-174.165.20.128/27
174.165.20.169-174.165.20.160/28
174.165.20.176-174.165.20.176/31
174.165.20.178-174.165.20.178/31
174.165.20.181-174.165.20.180/30
174.165.20.185-174.165.20.184/29
174.165.20.193-174.165.20.192/30
174.165.20.197-174.165.20.196/31
174.165.20.199-174.165.20.199/32
174.165.20.207-174.165.20.200/29
174.165.20.211-174.165.20.208/28
174.165.20.236-174.165.20.224/27
174.165.20.78-174.165.20.64/28
174.165.20.81-174.165.20.80/30
174.165.20.84-174.165.20.84/31
174.165.20.87-174.165.20.87/32
174.165.20.88-174.165.20.88/30
174.165.20.92-174.165.20.92/32
174.165.20.95-174.165.20.94/31
174.165.20.96-174.165.20.96/31
174.165.20.99-174.165.20.99/32
174.165.21.1-174.165.21.0/29
174.165.21.130-174.165.21.128/26
174.165.21.255-174.165.21.192/26
174.165.21.102-174.165.21.64/26
174.165.22.1-174.165.22.0/29
174.165.22.158-174.165.22.128/27
174.165.22.166-174.165.22.160/28
174.165.22.180-174.165.22.176/29
174.165.22.184-174.165.22.184/30
174.165.22.188-174.165.22.188/32
174.165.22.190-174.165.22.190/31
174.165.22.192-174.165.22.192/32
174.165.22.195-174.165.22.194/31
174.165.22.198-174.165.22.196/30
174.165.22.203-174.165.22.200/29
174.165.22.212-174.165.22.208/28
174.165.22.226-174.165.22.224/27
174.165.22.71-174.165.22.64/28
174.165.22.86-174.165.22.80/29
174.165.22.88-174.165.22.88/32
174.165.22.90-174.165.22.90/31
174.165.22.95-174.165.22.92/30
174.165.22.119-174.165.22.96/27
174.165.23.0-174.165.23.0/27
174.165.23.160-174.165.23.160/28
174.165.23.204-174.165.23.192/28
174.165.23.209-174.165.23.208/31
174.165.23.211-174.165.23.211/32
174.165.23.213-174.165.23.212/30
174.165.23.223-174.165.23.216/29
174.165.23.230-174.165.23.224/27
174.165.23.101-174.165.23.64/26
174.61.133.0-174.61.133.0/26
174.61.133.71-174.61.133.64/26
174.61.134.5-174.61.134.0/26
174.61.134.126-174.61.134.64/26
174.61.134.152-174.61.134.128/26
174.61.134.199-174.61.134.192/26
174.61.135.9-174.61.135.0/26
174.61.135.111-174.61.135.64/26
174.61.140.84-174.61.140.64/26
174.61.143.1-174.61.143.0/26
174.61.143.104-174.61.143.64/26
174.61.147.146-174.61.147.128/26
174.61.147.226-174.61.147.192/26
174.61.148.165-174.61.148.128/26
174.61.148.245-174.61.148.192/26
174.61.158.180-174.61.158.128/26
174.61.158.222-174.61.158.192/26
174.61.159.141-174.61.159.128/26
174.61.176.2-174.61.176.0/26
174.61.176.126-174.61.176.64/26
174.61.176.142-174.61.176.128/26
174.61.176.204-174.61.176.192/26
174.61.177.4-174.61.177.0/26
174.61.177.70-174.61.177.64/26
174.61.177.174-174.61.177.128/26
"""

inpt_ips = [entry.split('-')[0] for entry in inpt.split('\n')]
secure_key = '1002abbbeg-42f5aee4-e4d0-4570-a5cf-b31384860e44-Xyzngo'
split_key = secure_key.split('-')
ATLAS_STOP_API_KEY = '-'.join(split_key[1:-1])


def create_trace(ips):
    pings = []

    for ip in ips:
        ping = Ping(af=4, target=ip, description="testing new wrapper")
        pings.append(ping)

    source = AtlasSource(
    type="area",
    value="WW",
    requested=5,
    tags={"include":["system-ipv4-works"]}
        )
    
    start_time = datetime.now(timezone.utc) + timedelta(minutes=3)
    stop_time = start_time + timedelta(minutes=5)
    atlas_request = AtlasCreateRequest(
        start_time= start_time,
        stop_time = stop_time,
        key=ATLAS_STOP_API_KEY,
        measurements=pings,
        sources=[source],
        is_oneoff=False
    )
    

    (is_success, response) = atlas_request.create()
    if not is_success:
        raise Exception("Measurement Not Created, Please check reponse\n \t"+str(response))
    return response['measurements'][0],stop_time

def stop_measurement(msm):
    # Create an AtlasResultsRequest object
    atlas_request = AtlasStopRequest(msm_id=msm, key=ATLAS_STOP_API_KEY)

    # Send the request to stop the measurement
    (is_success, response) = atlas_request.create()
    if not is_success:
        raise Exception("Measurement Not Stopped, Please check reponse\n \t"+str(response))
    
def check_status(msm):
    status = Measurement(id=msm).status
    print(status)
    

batch1 = inpt_ips[:100]
batch2 = inpt_ips[100:200]
batch3 = inpt_ips[200:-1]

#NOTE:
# Don't stop until the measurement has started at least
#It might be better to keep a single one again -- since we are creating and stopping 2K at the same time
#Keep download seperate -- multi-processing
#msm,st = create_trace(batch1)
#print(msm)
#for i in tqdm(range(len(batch1))):
#    while datetime.now(timezone.utc) < st:
#        continue
#    stop_measurement(msm+i)

#msm,st = create_trace(batch2)
#print(msm)
#for i in tqdm(range(len(batch2))):
#    while datetime.now(timezone.utc) < st:
#        continue
#    stop_measurement(msm+i)

#msm,st = create_trace(batch3)
#print(msm)
#for i in tqdm(range(len(batch3))):
#    while datetime.now(timezone.utc) < st:
#       continue
#    stop_measurement(msm+i)

for i in range(100):
    check_status(95937272+i)

